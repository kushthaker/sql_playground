-- MEDIAN REFERRALS RECIEVED PER HUB (2.0) MONTHLY
with referral_count as 
(
  select to_char(r.created_at, 'YYYY-MM') as created_date, 
  subdomain,
  count(r.id) as referrals_count
  from referrals r
  inner join companies co on r.company_id = co.id
  where coalesce(co.salesforce_id,'') != ''
  and co.subdomain != 'vip'
  group by 1,2
)
select 
  distinct created_date as month,
  median(referrals_count) over (partition by created_date) as median_referrals_per_hub
from referral_count
where created_date != to_char(getdate(), 'YYYY-MM')
order by 1 asc

-- -- MEDIAN REFERRALS RECIEVED PER HUB (2.0) MONTHLY
-- -- Using 'in progress' referral milestone
-- with referral_count as 
-- (
--   select to_char(r.created_at, 'YYYY-MM') as created_date, 
--   subdomain,
--   count(distinct case when rm.type = 'won' then r.id else null end) as won,
--   count(distinct case when rm.type = 'in_progress' then r.id else null end) as qualified
--   from referrals r
--   inner join companies co on r.company_id = co.id
--   inner join referral_milestones rm on r.current_milestone_id = rm.id 
--   where subdomain in ('mobify', 'adeptia', 'seismic', 'envoy', 'modeln', 'samanage', 'hireright', '15five', 'siriusdecisions', 'maxsold', 'ecobee', 'touchbistro', 'onelogin', 'qlik', 'skyhighnetworks', 'evault', 'ultimatesoftware', 'echosign', 'esiinternational', 'leonardo', 'creationagency', 'shoretel', 'snacknation', 'cco', 'amtdirect', 'computersupport', 'salesforcepremier', 'smartenterprise', 'liaison', 'predictablerevenue', 'saucelabs', 'zama', 'recruitloop', 'druva', 'ektron', 'liveintent', 'joinme', 'on-site', 'plangrid', 'eventboard', 'pointdrive', 'fisherbioservices', 'ibmhybridcloud', 'mindjet', 'keepersecurity', 'vsl3', 'totango', 'forrester', 'aerohive', 'staples', 'xactly', 'connectandsell', 'iovation', 'kontagent', 'turnto', 'arrowecs', 'inkling', 'firstcal', 'membersolutions', 'coupa', 'opsbridgeinsiders', 'boomtown', 'epn', 'demandspring', 'conga', 'invoca', 'intalio', 'marketbridge', 'owncloud', 'loopup', 'revegy', 'glasscubes', 'nginx', 'lotame', 'whitlock', 'homestars', 'pgisales', 'clearslide', 'acquia', 'brainshark', 'zeroturnaround', 'eloqua', 'ocz', 'herok12', 'pulsesecure', 'arrowsi', 'ironmountain', 'forcepoint', 'springcm', 'astutesolutions', 'twitter', 'recombo', 'signatureworldwide', 'kissmetrics', 'shareologybook', 'clearcare', 'worketc', 'doubledutch', 'pardot', 'tribehr', 'vpprn', 'nwnit', 'blackline', 'billdotcom', 'smartthings', 'zenpayroll', 'firmex', 'pearson', 'verint', 'tagetik', 'datawatch', 'box', 'purestorage', 'anaplan', 'avalara', 'esker', 'apriori', 'ibmchampion', 'communityforce', 'learncore', 'schooladmin', 'ringcentral', 'watsonhealth', 'apminsiders', 'nitro', 'relayventures', 'clari', 'tangocard', 'code42software', 'fnts', 'kiratalent', 'hootsuite', 'neopost', 'socrata', 'hpadm', 'kace', 'zapproved', 'reviewsnap', 'riseinteractive', 'adaptiveinsights', 'zend', 'genologics', 'sas', 'acst', 'logmein', 'epicorsoftware', 'clearfit', 'netfactor', 'ibm', 'cija', 'billtrust', 'buffini', 'attask', 'cloudwords', 'cloudon', 'termsync', 'jwplayer', 'cvent', 'vht', 'acmcommunity', 'kubotek', 'desk', 'readytalk', 'semrush', 'adar', 'apigee', 'metaswitch', 'nexmo', 'tripleseat', 'swarm', 'veracode', 'paychex', 'mogiv', 'unitrends', 'xcmsolutions', 'intuitquickbase', 'adp', 'rapid7', 'adsensa', 'mitel', 'conductor', 'docusign', 'easycleanenergy', 'quorum', 'wegohealth', 'evolveip', 'blackberry', 'riverbed', 'bluemix', 'freshbooks', 'eastwick', 'limelight', 'macadamian', 'selectica', 'aryaka', 'ourcrowd', 'gochrysalis', 'datanauts', 'dyn', 'ceridian', 'sdl', 'nanawall', 'hortonworks', 'infoblox', 'skulpt', 'spiceworks', 'leadpages', 'cheebachews', 'namely', 'optimizely', 'tophat', 'hatchbuck', 'allocadia', 'acl', 'engineyard', 'transfast', 'smartbear', '1stlightenergy', 'socialimprints', 'appneta', 'bronto', 'dashlane', 'dynatrace', 'halogen', 'actuate', 'wrike', 'prnewswire', 'virginpulse', 'crazydomains', 'emc', 'databank', 'clinicient', 'leveleleven', 'findbetter', 'cielo', 'toast', 'innroad', 'savo', 'fuseuniversal', 'scholarswag', 'mongodb', 'insightsquared', 'klipfolio', 'northpoint', 'imginsiders', 'edmodo', 'gofmx', 'thepredictiveindex', 'parchment', 'rocketfuel', 'bankerstoolbox', 'demandgen', 'nutanix', 'clarizen', 'itominsiders', 'salesforce1platform', 'acronis', 'predixion', 'crimsonhexagon', 'nxtbookmedia', 'jda', 'demandbase', 'acquisio', 'atlassian', 'futuresuper', 'apprenda', 'neustar', 'fliptop', 'verafin', 'homeaway', 'tcsociety', 'insightpool', 'linkedin', 'cielotalent', 'netscout', 'cox', 'cloudelements', 'frost', 'glowpoint', 'dexterchaney', 'nlyte', 'hirevue', 'bah', 'insidesales', 'covidien', 'gnapartners', 'gooddata', 'calabrio', 'on24', 'symantecgold', 'intronis', 'qualtrics', 'getcake', 'smartling', 'couch-associates', 'salesloft', 'trelora', 'bistromd', 'siia', 'safedose', 'bluecat', 'acton', 'gainsight', 'couchdb', 'vif', 'apttus', 'impactgroup', 'rolepoint', 'businessolver', 'rivs', 'egencia', 'ilabsmoney', 'skotidasconsulting', 'kareo', 'procurify', 'peoplematter', 'datadotcom', 'insperity', 'bbchampions', 'hubspot', 'windward', 'opendns', 'knowledgevision', 'credibly', 'gohubble', 'silanis', 'quantum', 'res', 'hostanalytics', 'distilnetworks', 'uberflip', 'ezidebit', 'salesforcedevs', 'firstround', 'okta', 'alfresco', 'trinet', 'insurity', 'reltio', 'sococo', 'pitneybowes', 'marketo', 'replicon', 'marketingcloud', 'heinzmarketing', 'monetate', 'trackmaven', 'myjeweller', 'g5', 'hpsweducation', 'openview', 'compliancescience', 'diligent', 'elitesem', 'asigra', 'fleetsharp', 'enterasys', 'bomgar', 'mhiglobal', 'sleetergroup', 'devmvp', 'paysimple', 'ppminsiders', 'kapost', 'mulesoft', 'dundas', 'victorops', 'bmc', 'montage', 'vidyard', 'theclub', 'deltek', 'grasshopper', 'talari', 'mavenlink', 'netbase', 'customerreferenceforum', 'onecallnow', 'litmos', 'cloudbees', 'asusitaly', 'contactatonce', 'blackduck', 'junctionsolutions', 'insideview', 'reflexis', 'carouselindustries', 'myemma', 'greenbiz', 'tintri', 'hiremojo', 'aconex', 'zerto', 'oraclesocial', 'talentwise', 'armanino', 'centrify', 'pinnacleprivatewealth', 'wiley', 'fonality', 'pedowitzgroup', 'applause', 'infusionsoft', 'myhealthop', 'prounlimited', 'genesys', 'raml', 'uptimesoftware', 'qvidian', 'saiglobal', 'looker', 'pingidentity', 'zscaler', 'netprospex', 'discoverorg', 'jumio', 'opensesame', 'messagesystems', 'hoopla', 'smarttech', 'liveramp', 'commonangels', 'bluewolf', 'strongview', 'bullhorn', 'deliciousliving', 'five9', 'eteacher', 'articulate-insiders', 'aciworldwide', 'zenpayroll-partner', 'mercurylabs', 'simplivity', 'brightpearl', 'inin', 'imanami', 'connectfirst', 'devolutions', 'icompass', 'stansberry', 'smashfly', 'moneytips', 'pgi')
--   group by 1,2
-- )
-- select 
--   distinct created_date as month,
--   median(won) over (partition by created_date) as median_referrals_per_hub_won,
--   median(qualified) over (partition by created_date) as median_referrals_per_hub_qualified
-- from referral_count
-- where created_date != to_char(getdate(), 'YYYY-MM')
-- order by 1 asc

-- -- REFERRALS 1.0
-- with ref_one_count as
-- (
-- select
--   to_char(e.created_at, 'YYYY-MM') as created_date, 
--   subdomain,
--   count(DISTINCT case when (e.type like 'referred_prospect_won') then e.id else null end) as won,
--   count(DISTINCT CASE WHEN (e.type LIKE 'referred_prospect_accepted') THEN e.id ELSE NULL END) as qualified
-- from events e 
-- inner join companies c on e.company_id = c.id
-- where subdomain in ('mobify', 'adeptia', 'seismic', 'envoy', 'modeln', 'samanage', 'hireright', '15five', 'siriusdecisions', 'maxsold', 'ecobee', 'touchbistro', 'onelogin', 'qlik', 'skyhighnetworks', 'evault', 'ultimatesoftware', 'echosign', 'esiinternational', 'leonardo', 'creationagency', 'shoretel', 'snacknation', 'cco', 'amtdirect', 'computersupport', 'salesforcepremier', 'smartenterprise', 'liaison', 'predictablerevenue', 'saucelabs', 'zama', 'recruitloop', 'druva', 'ektron', 'liveintent', 'joinme', 'on-site', 'plangrid', 'eventboard', 'pointdrive', 'fisherbioservices', 'ibmhybridcloud', 'mindjet', 'keepersecurity', 'vsl3', 'totango', 'forrester', 'aerohive', 'staples', 'xactly', 'connectandsell', 'iovation', 'kontagent', 'turnto', 'arrowecs', 'inkling', 'firstcal', 'membersolutions', 'coupa', 'opsbridgeinsiders', 'boomtown', 'epn', 'demandspring', 'conga', 'invoca', 'intalio', 'marketbridge', 'owncloud', 'loopup', 'revegy', 'glasscubes', 'nginx', 'lotame', 'whitlock', 'homestars', 'pgisales', 'clearslide', 'acquia', 'brainshark', 'zeroturnaround', 'eloqua', 'ocz', 'herok12', 'pulsesecure', 'arrowsi', 'ironmountain', 'forcepoint', 'springcm', 'astutesolutions', 'twitter', 'recombo', 'signatureworldwide', 'kissmetrics', 'shareologybook', 'clearcare', 'worketc', 'doubledutch', 'pardot', 'tribehr', 'vpprn', 'nwnit', 'blackline', 'billdotcom', 'smartthings', 'zenpayroll', 'firmex', 'pearson', 'verint', 'tagetik', 'datawatch', 'box', 'purestorage', 'anaplan', 'avalara', 'esker', 'apriori', 'ibmchampion', 'communityforce', 'learncore', 'schooladmin', 'ringcentral', 'watsonhealth', 'apminsiders', 'nitro', 'relayventures', 'clari', 'tangocard', 'code42software', 'fnts', 'kiratalent', 'hootsuite', 'neopost', 'socrata', 'hpadm', 'kace', 'zapproved', 'reviewsnap', 'riseinteractive', 'adaptiveinsights', 'zend', 'genologics', 'sas', 'acst', 'logmein', 'epicorsoftware', 'clearfit', 'netfactor', 'ibm', 'cija', 'billtrust', 'buffini', 'attask', 'cloudwords', 'cloudon', 'termsync', 'jwplayer', 'cvent', 'vht', 'acmcommunity', 'kubotek', 'desk', 'readytalk', 'semrush', 'adar', 'apigee', 'metaswitch', 'nexmo', 'tripleseat', 'swarm', 'veracode', 'paychex', 'mogiv', 'unitrends', 'xcmsolutions', 'intuitquickbase', 'adp', 'rapid7', 'adsensa', 'mitel', 'conductor', 'docusign', 'easycleanenergy', 'quorum', 'wegohealth', 'evolveip', 'blackberry', 'riverbed', 'bluemix', 'freshbooks', 'eastwick', 'limelight', 'macadamian', 'selectica', 'aryaka', 'ourcrowd', 'gochrysalis', 'datanauts', 'dyn', 'ceridian', 'sdl', 'nanawall', 'hortonworks', 'infoblox', 'skulpt', 'spiceworks', 'leadpages', 'cheebachews', 'namely', 'optimizely', 'tophat', 'hatchbuck', 'allocadia', 'acl', 'engineyard', 'transfast', 'smartbear', '1stlightenergy', 'socialimprints', 'appneta', 'bronto', 'dashlane', 'dynatrace', 'halogen', 'actuate', 'wrike', 'prnewswire', 'virginpulse', 'crazydomains', 'emc', 'databank', 'clinicient', 'leveleleven', 'findbetter', 'cielo', 'toast', 'innroad', 'savo', 'fuseuniversal', 'scholarswag', 'mongodb', 'insightsquared', 'klipfolio', 'northpoint', 'imginsiders', 'edmodo', 'gofmx', 'thepredictiveindex', 'parchment', 'rocketfuel', 'bankerstoolbox', 'demandgen', 'nutanix', 'clarizen', 'itominsiders', 'salesforce1platform', 'acronis', 'predixion', 'crimsonhexagon', 'nxtbookmedia', 'jda', 'demandbase', 'acquisio', 'atlassian', 'futuresuper', 'apprenda', 'neustar', 'fliptop', 'verafin', 'homeaway', 'tcsociety', 'insightpool', 'linkedin', 'cielotalent', 'netscout', 'cox', 'cloudelements', 'frost', 'glowpoint', 'dexterchaney', 'nlyte', 'hirevue', 'bah', 'insidesales', 'covidien', 'gnapartners', 'gooddata', 'calabrio', 'on24', 'symantecgold', 'intronis', 'qualtrics', 'getcake', 'smartling', 'couch-associates', 'salesloft', 'trelora', 'bistromd', 'siia', 'safedose', 'bluecat', 'acton', 'gainsight', 'couchdb', 'vif', 'apttus', 'impactgroup', 'rolepoint', 'businessolver', 'rivs', 'egencia', 'ilabsmoney', 'skotidasconsulting', 'kareo', 'procurify', 'peoplematter', 'datadotcom', 'insperity', 'bbchampions', 'hubspot', 'windward', 'opendns', 'knowledgevision', 'credibly', 'gohubble', 'silanis', 'quantum', 'res', 'hostanalytics', 'distilnetworks', 'uberflip', 'ezidebit', 'salesforcedevs', 'firstround', 'okta', 'alfresco', 'trinet', 'insurity', 'reltio', 'sococo', 'pitneybowes', 'marketo', 'replicon', 'marketingcloud', 'heinzmarketing', 'monetate', 'trackmaven', 'myjeweller', 'g5', 'hpsweducation', 'openview', 'compliancescience', 'diligent', 'elitesem', 'asigra', 'fleetsharp', 'enterasys', 'bomgar', 'mhiglobal', 'sleetergroup', 'devmvp', 'paysimple', 'ppminsiders', 'kapost', 'mulesoft', 'dundas', 'victorops', 'bmc', 'montage', 'vidyard', 'theclub', 'deltek', 'grasshopper', 'talari', 'mavenlink', 'netbase', 'customerreferenceforum', 'onecallnow', 'litmos', 'cloudbees', 'asusitaly', 'contactatonce', 'blackduck', 'junctionsolutions', 'insideview', 'reflexis', 'carouselindustries', 'myemma', 'greenbiz', 'tintri', 'hiremojo', 'aconex', 'zerto', 'oraclesocial', 'talentwise', 'armanino', 'centrify', 'pinnacleprivatewealth', 'wiley', 'fonality', 'pedowitzgroup', 'applause', 'infusionsoft', 'myhealthop', 'prounlimited', 'genesys', 'raml', 'uptimesoftware', 'qvidian', 'saiglobal', 'looker', 'pingidentity', 'zscaler', 'netprospex', 'discoverorg', 'jumio', 'opensesame', 'messagesystems', 'hoopla', 'smarttech', 'liveramp', 'commonangels', 'bluewolf', 'strongview', 'bullhorn', 'deliciousliving', 'five9', 'eteacher', 'articulate-insiders', 'aciworldwide', 'zenpayroll-partner', 'mercurylabs', 'simplivity', 'brightpearl', 'inin', 'imanami', 'connectfirst', 'devolutions', 'icompass', 'stansberry', 'smashfly', 'moneytips', 'pgi')
-- group by 1,2
-- )
-- select 
--   distinct created_date as month,
--   median(won) over (partition by created_date) as median_referrals_per_hub_won,
--   median(qualified) over (partition by created_date) as median_referrals_per_hub_qualified
-- from ref_one_count
-- where created_date != to_char(getdate(), 'YYYY-MM')
-- order by 1 asc

